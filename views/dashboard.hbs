<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vintage Addiction</title>
  <link rel="stylesheet" href="stylesheets/css.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap"
    rel="stylesheet">
  <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-bold-rounded/css/uicons-bold-rounded.css'>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-qKXV1j0HvMUeCBQ+QVp7JcfGl760yU08IQ+GpUo5hlbpg51QRiuqHAJz8+BrxE/N"
          crossorigin="anonymous"></script>
</head>


<body>

<header>
  <nav class="navbar bg-body-tertiary fixed-top " style="background-color: #480b97 !important;">
    <div class="container col-12 col-md-12 col-lg-12 col-xl-12">
      <a class="navbar-brand" href="/"><img class="logo" src="images/logo.png"/></a>
      <a onclick="logOut()" class="nav-link" href="/logout"><i class="fi fi-br-address-card white"
                                                               style="font-size:28px;"></i></a>
    </div>
  </nav>
</header>

<div class="container col-12 col-md-12 col-lg-12 col-xl-12 " style="margin-top: 120px;">

  <div class="row justify-content-md-center white">
    <div class="col">
      <h2 id="user">{{user.username}} DASHBOARD</h2>
    </div>
  </div>

  <div class="row justify-content-md-center white">
    <div class="col ">
      <p id="room">FAVORITE ROOM: {{user.room}}</p>
    </div>
  </div>

  <div draggable="true" class="row justify-content-center">
    <img id="avatar" style="width: 100px;" alt="Avatar" class="bradius" src="{{user.avatar}}"/>
  </div>

  <div class="row justify-content-center text-center white rowdash">
    <h2 style="font-weight: 700">Chose your room!</h2>
    <p style="font-weight: 300">To chose your room drag your avatar to the room's number :)</p>
  </div>

  <div class="d-flex justify-content-center">
    <div id="room01" class="col-2 text-center salas">
      <img name="rooms" src="images/room01.png" alt="Room" class="bradius salanum room-avatar"/>
      <div class="empty"><p class="m-3 white">Empty</p></div>
      <div class="waiting"><p class="m-3 white">Waiting</p></div>
      <div class="full"><p class="m-3 white">Full</p></div>
      <div class="leave">
        <button class="btn btn-primary btn-lg btn-block playbtn" type="submit" onclick="leaveRoom()">Leave</button>
      </div>
      <div class="play">
        <a class="btn btn-primary btn-lg btn-block playbtn" type="submit" href="/rooms/room01">Play!</a>
      </div>
    </div>
    <div id="room02" class="col-2 text-center salas">
      <img name="rooms" src="images/room02.png" alt="Room" class="bradius salanum room-avatar"/>
      <div class="empty"><p class="m-3 white">Empty</p></div>
      <div class="waiting"><p class="m-3 white">Waiting</p></div>
      <div class="full"><p class="m-3 white">Full</p></div>
      <div class="leave">
        <button class="btn btn-primary btn-lg btn-block playbtn" type="submit" onclick="leaveRoom()">Leave</button>
      </div>
      <div class="play">
        <a class="btn btn-primary btn-lg btn-block playbtn" type="submit" href="/rooms/room02">Play!</a>
      </div>
    </div>
    <div id="room03" class="col-2 text-center salas">
      <img name="rooms" src="images/room03.png" alt="Room" class="bradius salanum room-avatar"/>
      <div class="empty"><p class="m-3 white">Empty</p></div>
      <div class="waiting"><p class="m-3 white">Waiting</p></div>
      <div class="full"><p class="m-3 white">Full</p></div>
      <div class="leave">
        <button class="btn btn-primary btn-lg btn-block playbtn" type="submit" onclick="leaveRoom()">Leave</button>
      </div>
      <div class="play">
        <a class="btn btn-primary btn-lg btn-block playbtn" type="submit" href="/rooms/room03">Play!</a>
      </div>
    </div>
    <div id="room04" class="col-2 text-center salas">
      <img name="rooms" src="images/room04.png" alt="Room" class="bradius salanum room-avatar"/>
      <div class="empty"><p class="m-3 white">Empty</p></div>
      <div class="waiting"><p class="m-3 white">Waiting</p></div>
      <div class="full"><p class="m-3 white">Full</p></div>
      <div class="leave">
        <button class="btn btn-primary btn-lg btn-block playbtn" type="submit" onclick="leaveRoom()">Leave</button>
      </div>
      <div class="play">
        <a class="btn btn-primary btn-lg btn-block playbtn" type="submit" href="/rooms/room04">Play!</a>
      </div>
    </div>
  </div>
</div>

</div>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  var socket = io();
  const myEmail = "{{user.email}}"

  socket.on('rooms:status', (data) => {
    const myRoom = getMyRoom(data);

    data.forEach(room => {
      const container = document.getElementById(room.id);

      if (myRoom) {
          if (myRoom.id === room.id) {
            container.querySelectorAll('.room-avatar')[0].style.opacity = 1;
            container.querySelectorAll('.waiting')[0].classList.remove('hidden');

            room.users.length === 2
              ? container.querySelectorAll('.play')[0].classList.remove('hidden')
              : container.querySelectorAll('.play')[0].classList.add('hidden');

            container.querySelectorAll('.leave')[0].classList.remove('hidden');
            container.querySelectorAll('.full')[0].classList.add('hidden');
            container.querySelectorAll('.empty')[0].classList.add('hidden');
          } else {
            container.querySelectorAll('.room-avatar')[0].style.opacity = 0.5;

            room.users.length === 1
              ? container.querySelectorAll('.waiting')[0].classList.remove('hidden')
              : container.querySelectorAll('.waiting')[0].classList.add('hidden');

            room.users.length === 2
              ? container.querySelectorAll('.full')[0].classList.remove('hidden')
              : container.querySelectorAll('.full')[0].classList.add('hidden');

            container.querySelectorAll('.play')[0].classList.add('hidden');
            container.querySelectorAll('.leave')[0].classList.add('hidden');

            room.users.length === 0
              ? container.querySelectorAll('.empty')[0].classList.remove('hidden')
              : container.querySelectorAll('.empty')[0].classList.add('hidden')

          }
      } else {
        container.querySelectorAll('.room-avatar')[0].style.opacity = 1;
        container.querySelectorAll('.play')[0].classList.add('hidden');
        container.querySelectorAll('.leave')[0].classList.add('hidden');

        room.users.length === 1
          ? container.querySelectorAll('.waiting')[0].classList.remove('hidden')
          : container.querySelectorAll('.waiting')[0].classList.add('hidden');

        room.users.length === 2
          ? container.querySelectorAll('.full')[0].classList.remove('hidden')
          : container.querySelectorAll('.full')[0].classList.add('hidden');

        room.users.length === 0
          ? container.querySelectorAll('.empty')[0].classList.remove('hidden')
          : container.querySelectorAll('.empty')[0].classList.add('hidden')
      }
    });

  });

  /**
   * Returns the room where the user joined or undefined in case is not in any room
   * @param rooms
   */
  function getMyRoom(rooms) {
    return rooms
      .filter(room =>
        room.users.filter(user => user.email === myEmail).length > 0
      )[0];
  }

  function leaveRoom() {
    socket.emit('rooms:leave');
  }


  //Add drag & drop capabilties
  const img = document.getElementById("avatar");
  img.addEventListener('dragstart', dragStart);

  function dragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.id);
    setTimeout(() => {
      e.target.classList.add('hide');
    }, 0);
  }

  const rooms = document.querySelectorAll(".room-avatar");
  rooms.forEach(room => {
    room.addEventListener('dragenter', dragEnter)
    room.addEventListener('dragover', dragOver);
    room.addEventListener('dragleave', dragLeave);
    room.addEventListener('drop', drop);

  });

  function dragEnter(e) {
    e.preventDefault();
    e.target.classList.add('drag-over');

  }

  function dragOver(e) {
    e.preventDefault();
    e.target.classList.add('drag-over');
  }

  function dragLeave(e) {
    e.target.classList.remove('drag-over');

  }

  function drop(e) {
    const roomId = e.target.parentElement.id;
    socket.emit('rooms:join', roomId);
  }

  function logOut() {
    localStorage.clear();
    location.replace("/logout")
  }

</script>


</body>
</html>

